<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneSignal Push Notification Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        body {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .notification-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        #notification-log {
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4">Push Notification Demo</h1>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">OneSignal Push Notifications</h5>
                <p class="card-text">This demo shows how to implement web push notifications using OneSignal.</p>
                
                <div id="notification-permission" class="notification-status bg-light">
                    <p>Notification permission status: <span id="permission-status" class="fw-bold">Checking...</span></p>
                    <button id="enable-notifications" class="btn btn-primary" disabled>Enable Notifications</button>
                    <button id="test-notification" class="btn btn-success" disabled>Send Test Notification</button>
                </div>
                
                <div class="mt-4">
                    <h6>Notification Log:</h6>
                    <div id="notification-log"></div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h5>How it works:</h5>
            <ol>
                <li>Click "Enable Notifications" to allow push notifications</li>
                <li>Click "Send Test Notification" to receive a demo notification</li>
                <li>You'll receive actual notifications even when the tab is closed</li>
            </ol>
        </div>
    </div>

    <script>
        // Store OneSignal reference globally
        let oneSignalInitialized = false;
        let oneSignalInstance = null;

        // Initialize OneSignal with your App ID
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(function(OneSignal) {
            oneSignalInstance = OneSignal;
            OneSignal.init({
                appId: "21ecc723-d37d-4e0a-b86b-52217fc4bf93",
                safari_web_id: "web.onesignal.auto.1a6a5c8f-1e8b-4a3a-8f0d-2e8b5f3a1d6c",
                notifyButton: {
                    enable: true,
                },
                allowLocalhostAsSecureOrigin: true,
            }).then(function() {
                oneSignalInitialized = true;
                logMessage("OneSignal initialized successfully");
                
                // Once initialized, you can get the user ID
                OneSignal.getUserId().then(function(userId) {
                    logMessage("OneSignal User ID: " + (userId || "Not available yet"));
                });
                
                // Check notification permission
                checkNotificationPermission();
                
                // Setup button event listeners
                setupButtons();
            }).catch(function(error) {
                logMessage("OneSignal initialization error: " + error);
            });
        });

        function checkNotificationPermission() {
            if (!oneSignalInitialized) {
                logMessage("OneSignal not initialized yet");
                return;
            }
            
            oneSignalInstance.Notifications.isPushSupported().then(function(isSupported) {
                if (isSupported) {
                    oneSignalInstance.Notifications.permission().then(function(permission) {
                        updatePermissionUI(permission);
                    });
                } else {
                    document.getElementById('permission-status').textContent = "Push not supported";
                    document.getElementById('enable-notifications').disabled = true;
                    logMessage("Push notifications are not supported in this browser.");
                }
            });
        }

        function updatePermissionUI(permission) {
            const statusElement = document.getElementById('permission-status');
            const enableButton = document.getElementById('enable-notifications');
            const testButton = document.getElementById('test-notification');
            
            if (permission) {
                statusElement.textContent = "Granted";
                statusElement.className = "fw-bold text-success";
                enableButton.textContent = "Disable Notifications";
                enableButton.className = "btn btn-warning";
                testButton.disabled = false;
                logMessage("Notification permission granted.");
            } else {
                statusElement.textContent = "Denied";
                statusElement.className = "fw-bold text-danger";
                enableButton.textContent = "Enable Notifications";
                enableButton.className = "btn btn-primary";
                testButton.disabled = true;
                logMessage("Notification permission denied.");
            }
            enableButton.disabled = false;
        }

        function setupButtons() {
            document.getElementById('enable-notifications').addEventListener('click', function() {
                if (!oneSignalInitialized) {
                    logMessage("OneSignal not initialized yet - please wait");
                    return;
                }
                
                oneSignalInstance.Notifications.permission().then(function(permission) {
                    if (permission) {
                        // If permission is granted, clicking will revoke it
                        oneSignalInstance.Notifications.setPermission(false);
                        logMessage("Notifications disabled.");
                        updatePermissionUI(false);
                    } else {
                        // If permission is not granted, request it
                        oneSignalInstance.Notifications.requestPermission().then(function(accepted) {
                            if (accepted) {
                                logMessage("Notification permission accepted.");
                            } else {
                                logMessage("Notification permission rejected.");
                            }
                            checkNotificationPermission();
                        });
                    }
                });
            });
            
            document.getElementById('test-notification').addEventListener('click', function() {
                if (!oneSignalInitialized) {
                    logMessage("OneSignal not initialized yet - please wait");
                    return;
                }
                
                // Add event listeners for notification interactions
                oneSignalInstance.Notifications.addEventListener('foreground', function(event) {
                    logMessage("Notification received while browser is open: " + event.title);
                });
                
                oneSignalInstance.Notifications.addEventListener('click', function(event) {
                    logMessage("Notification clicked: " + event.title);
                });
                
                // Simulate a notification
                const notification = {
                    title: "Test Notification",
                    body: "This is a test notification from your website!",
                    url: window.location.href,
                    icon: "https://onesignal.com/images/notification_logo.png"
                };
                
                oneSignalInstance.Notifications.create(notification).then(function() {
                    logMessage("Test notification sent successfully.");
                }).catch(function(error) {
                    logMessage("Error sending test notification: " + error);
                });
            });
        }

        function logMessage(message) {
            const logElement = document.getElementById('notification-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.prepend(logEntry);
            
            // Keep log to 20 entries max
            if (logElement.children.length > 20) {
                logElement.removeChild(logElement.lastChild);
            }
        }

        // Fallback in case OneSignal takes too long to load
        setTimeout(function() {
            if (!oneSignalInitialized) {
                logMessage("Waiting for OneSignal to initialize...");
                document.getElementById('enable-notifications').disabled = false;
                document.getElementById('enable-notifications').addEventListener('click', function() {
                    logMessage("OneSignal still initializing - please wait");
                });
            }
        }, 5000);
    </script>
</body>
</html>
